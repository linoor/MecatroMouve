<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Mécatromouve by linoor</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Mécatromouve</h1>
        <h2></h2>
        <a href="https://github.com/linoor/MecatroMouve" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>
<a id="gomouve" class="anchor" href="#gomouve" aria-hidden="true"><span class="octicon octicon-link"></span></a>GoMouve</h1>

<p><strong>prototype version 0.1</strong></p>

<p>This document provides a tutorial on how to set up the micro-controller part of the <a href="https://sites.google.com/site/20142015gr08/home">GoMouve</a> project, and explains how it works.</p>

<h2>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h2>

<p>It contains 2 Arduinos, one as <em>sender</em> (the moving target), the other as <em>receiver</em> (the camera).<br>
<em>Sender</em> collects its altitude (barometer) and location (GPS) then sends to receiver. While <em>receiver</em> collects them as well as its own altitude, location, and direction (magnetometer). It then computes the angle the camera should turn.</p>

<h2>
<a id="set-up" class="anchor" href="#set-up" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set Up</h2>

<h4>
<a id="components" class="anchor" href="#components" aria-hidden="true"><span class="octicon octicon-link"></span></a>Components</h4>

<p>For <em>sender</em> and <em>receiver</em>, the following devices are required:</p>

<h5>
<a id="sender" class="anchor" href="#sender" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sender</h5>

<ul>
<li>Arduino Uno * 1</li>
<li>XBee &amp; shield * 1</li>
<li>GPS (with antenna) * 1</li>
<li>Barometer * 1</li>
</ul>

<h5>
<a id="receiver" class="anchor" href="#receiver" aria-hidden="true"><span class="octicon octicon-link"></span></a>Receiver</h5>

<ul>
<li>Arduino Uno * 1</li>
<li>XBee &amp; shield * 1</li>
<li>GPS (with antenna) * 1</li>
<li>Barometer * 1</li>
<li><del>9DOF * 1</del></li>
<li><del>Servo * 2</del></li>
</ul>

<p><em>Current models: <a href="http://www.cooking-hacks.com/shop/arduino/arduino-xbee-802-15-4">XBee &amp; shield</a>, <a href="http://www.adafruit.com/product/746">GPS</a>, <a href="http://www.adafruit.com/product/1893">Barometer</a>, <a href="http://www.adafruit.com/product/1714">9DOF</a>, <a href="http://www.miniplanes.fr/servos/tower-pro/mini-servo-9g-towerpro-sg90-p-2995.html">Servo</a></em></p>

<h4>
<a id="wiring" class="anchor" href="#wiring" aria-hidden="true"><span class="octicon octicon-link"></span></a>Wiring</h4>

<h5>
<a id="sender-1" class="anchor" href="#sender-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sender</h5>

<p><img src="https://dl.dropboxusercontent.com/u/17953813/img/sender.png" alt="Alt text" title="sender's sketch"></p>

<h5>
<a id="receiver-1" class="anchor" href="#receiver-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Receiver</h5>

<p><img src="https://dl.dropboxusercontent.com/u/17953813/img/receiver.png" alt="Alt text" title="receiver's sketch">
Note:</p>

<ul>
<li>Check the ports for <strong><em>SCL</em></strong> and <strong><em>SDA</em></strong> of your Arduino board</li>
<li><em>The Adafruit 9DOF sensor is currently not in use.</em></li>
<li>*The servo has been changed.</li>
</ul>

<h4>
<a id="uploading-scripts" class="anchor" href="#uploading-scripts" aria-hidden="true"><span class="octicon octicon-link"></span></a>Uploading Scripts</h4>

<ol>
<li>Get scripts of <em>sender</em> and <em>receiver</em> from <a href="https://github.com/linoor/MecatroMouve/tree/master">here</a> (each in <code>XBee/sender</code>,  <code>XBee/receiver</code>)</li>
<li>Download and import required libraries (see below)</li>
<li>Set <code>GPSRXPin</code> <code>GPSTXPin</code> values according to circuit (<code>GPSRXPin</code> connects the <strong><em>TX</em></strong> pin of GPS, and vice versa)</li>
<li><del>Set ports for Servos as first parameters in
<code>myservoVertical.attach(PORT_V, 500, 2400)</code> <code>myservoHorizontal.attach(PORT_H, 500, 2400)</code></del></li>
<li>Upload script to Arduino board
<strong><em>Remember to turn jumpers of XBee shields into USB mode</em></strong> <em><a href="http://electronics.stackexchange.com/questions/25574/xbee-shield-turning-jumper-settings-into-on-off-xbee-usb-manual-switch">ref</a></em>
</li>
<li>Configure baudrate to <code>57600</code> for Serial Monitor</li>
</ol>

<h4>
<a id="required-libraries" class="anchor" href="#required-libraries" aria-hidden="true"><span class="octicon octicon-link"></span></a>Required Libraries</h4>

<p>GPS</p>

<ul>
<li><del><a href="https://github.com/mikalhart/TinyGPSPlus/releases">TinyGPS++</a></del></li>
<li><a href="https://github.com/adafruit/Adafruit-GPS-Library">Adafruit_GPS</a></li>
</ul>

<p>Barometer</p>

<ul>
<li><a href="https://github.com/adafruit/Adafruit_MPL3115A2_Library">MPL3115A2</a></li>
</ul>

<p>9DoF</p>

<ul>
<li><a href="https://github.com/adafruit/Adafruit_Sensor">Adafruit_Sensor</a></li>
<li><a href="https://github.com/adafruit/Adafruit_LSM303DLHC">Adafruit_LSM303_U</a></li>
<li><a href="https://github.com/adafruit/Adafruit_L3GD20_U">Adafruit_L3GD20_U</a></li>
</ul>

<h2>
<a id="explanation" class="anchor" href="#explanation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Explanation</h2>

<h3>
<a id="communication-process" class="anchor" href="#communication-process" aria-hidden="true"><span class="octicon octicon-link"></span></a>Communication Process</h3>

<h4>
<a id="xbee-handshaking" class="anchor" href="#xbee-handshaking" aria-hidden="true"><span class="octicon octicon-link"></span></a>XBee Handshaking</h4>

<ul>
<li>
<p>In <code>sender.ino</code>:</p>

<div class="highlight highlight-cpp"><pre><span class="pl-k">while</span> (<span class="pl-c1">true</span>)
{
    Serial.<span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>A<span class="pl-pds">"</span></span>);
    <span class="pl-c1">delay</span>(<span class="pl-c1">50</span>);
    <span class="pl-k">while</span> (Serial.<span class="pl-c1">available</span>())
    {
        <span class="pl-c">// Serial.println("Available");</span>
        <span class="pl-k">if</span> (Serial.<span class="pl-c1">read</span>() == <span class="pl-s"><span class="pl-pds">'</span>B<span class="pl-pds">'</span></span>)
        {
            <span class="pl-c">// Serial.println("Read B");</span>
            Serial.<span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>Setup finished!<span class="pl-pds">"</span></span>);
            <span class="pl-k">return</span>;
        }
    }
}</pre></div>
</li>
<li>
<p>In <code>receiver.ino</code>:</p>

<div class="highlight highlight-cpp"><pre><span class="pl-k">while</span> (<span class="pl-c1">true</span>)
{
    <span class="pl-c1">delay</span>(<span class="pl-c1">10</span>);
    <span class="pl-k">if</span> (Serial.<span class="pl-c1">available</span>())
    {
        <span class="pl-k">if</span> (Serial.<span class="pl-c1">read</span>() == <span class="pl-s"><span class="pl-pds">'</span>A<span class="pl-pds">'</span></span>)
        {
            <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; <span class="pl-c1">10</span>; i++)
            {
                Serial.<span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>B<span class="pl-pds">"</span></span>);
            }
            <span class="pl-k">return</span>;
        }
    }
}</pre></div>
</li>
</ul>

<ol>
<li>The <em>sender</em> sends out <code>A</code> continuously.</li>
<li>Once the <em>receiver</em> receives <code>A</code>, it returns <code>B</code> for 10 times and leaves the session.</li>
<li>Once the <em>sender</em> receives <code>B</code>, handshaking ends.</li>
</ol>

<p>Note:</p>

<ul>
<li>Pass the parameter to <code>Serial.print</code>(or <code>write</code>) as <code>string</code>, while</li>
</ul>

<h4>
<a id="sending-data" class="anchor" href="#sending-data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sending Data</h4>

<p>The transmission of data between XBees is facilited with C++ data type <code>union</code>.</p>

<p>For example:</p>

<div class="highlight highlight-cpp"><pre><span class="pl-k">union</span> bytes
{
    <span class="pl-k">float</span> f;
    byte b[<span class="pl-k">sizeof</span>(<span class="pl-k">float</span>)];
}</pre></div>

<p>Variables <code>f</code> and <code>b</code> actually point to the same memory block (4 bytes in this case), which allows us to manipulate the data as <code>float</code> number, and to send data as byte over XBee.</p>

<div class="highlight highlight-cpp"><pre>bytes data;
<span class="pl-c">// manipulation of data</span>
<span class="pl-c">// e.g. data.f = myPressure.readAltitude();</span>

Serial.write(data.b, <span class="pl-k">sizeof</span>(<span class="pl-k">float</span>));</pre></div>

<p>To handle each ideal data type of the sensor, we thereby implement this part with C++ template.</p>

<p>Each data set should be sent at each refresh with a starting signal, a data type signal, and an ending signal to prevent <code>receiver</code> from parsing incorrectly due to data loss.</p>

<p>As in <code>sendData</code> function:</p>

<div class="highlight highlight-cpp"><pre><span class="pl-k">template </span>&lt;<span class="pl-k">typename</span> T&gt;
<span class="pl-k">void</span> <span class="pl-en">sendData</span>(bytes&lt;T&gt; dataToSend[], <span class="pl-k">int</span> dataSize, String typeSignal)
{
    Serial.<span class="pl-c1">print</span>(START_SIGNAL);
    Serial.<span class="pl-c1">print</span>(typeSignal);
    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; dataSize; i++)
    {
        Serial.<span class="pl-c1">write</span>(dataToSend[i].<span class="pl-smi">b</span>, <span class="pl-k">sizeof</span>(T));
    }
    Serial.<span class="pl-c1">print</span>(END_SIGNAL);
}</pre></div>

<p>The current setting of protocal follows</p>

<ul>
<li>
<code>START_SIGNAL</code>: s</li>
<li>
<code>END_SIGNAL</code>: e</li>
<li>
<code>typeSignal</code>: a, g, d, i, l, f (as altitude, location (2D), debug, <code>int</code>, <code>long</code>, <code>float</code>)</li>
</ul>

<h3>
<a id="moving-camera" class="anchor" href="#moving-camera" aria-hidden="true"><span class="octicon octicon-link"></span></a>Moving Camera</h3>

<h4>
<a id="sender-2" class="anchor" href="#sender-2" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sender</h4>

<h4>
<a id="receiver-2" class="anchor" href="#receiver-2" aria-hidden="true"><span class="octicon octicon-link"></span></a>Receiver</h4>

<h4>
<a id="formula" class="anchor" href="#formula" aria-hidden="true"><span class="octicon octicon-link"></span></a>Formula</h4>

<h2>
<a id="todo" class="anchor" href="#todo" aria-hidden="true"><span class="octicon octicon-link"></span></a>TODO</h2>

<ul>
<li>moving camera part (barometer first, then self-calibration of receiver, and finally with GPS location)</li>
<li>optimize handshaking</li>
</ul>

<p><em>updated by Eric Chiu 05.05.15</em></p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/linoor/MecatroMouve/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/linoor/MecatroMouve/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/linoor/MecatroMouve"></a> is maintained by <a href="https://github.com/linoor">linoor</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>
